# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# dev-deploy.yml â€” Build platform-api + dashboard UI and deploy
# both to your local Kind cluster via kindling.
#
# Uses reusable kindling actions to eliminate boilerplate:
#   - kindling-detect-changes: skip unchanged services
#   - kindling-build:          Kaniko image build via sidecar
#   - kindling-deploy:         DSE apply + rollout wait via sidecar 
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
name: Dev Deploy

on:
  push:
    branches: [main]
  workflow_dispatch:

env:
  REGISTRY: "registry:5000"
  TAG: "${{ github.actor }}-${{ github.sha }}"

jobs:
  build-and-deploy:
    runs-on: [self-hosted, "${{ github.actor }}"]

    steps:
      # â”€â”€ 0. Checkout â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 2   # need previous commit for change detection

      # â”€â”€ 1. Detect changes â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Detect changes
        id: changes
        uses: jeff-vincent/kindling/.github/actions/kindling-detect-changes@main
        with:
          services: '[{"name":"platform-api","path":"./"},{"name":"platform-api-ui","path":"./ui"}]'
          actor: ${{ github.actor }}

      # â”€â”€ 2. Build API (if changed) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Build API image
        if: fromJSON(steps.changes.outputs.changes).platform-api
        uses: jeff-vincent/kindling/.github/actions/kindling-build@main
        with:
          name: platform-api
          context: ${{ github.workspace }}
          image: "${{ env.REGISTRY }}/platform-api:${{ env.TAG }}"
          exclude: "./ui"

      # â”€â”€ 3. Build UI (if changed) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Build UI image
        if: fromJSON(steps.changes.outputs.changes).platform-api-ui
        uses: jeff-vincent/kindling/.github/actions/kindling-build@main
        with:
          name: platform-api-ui
          context: "${{ github.workspace }}/ui"
          image: "${{ env.REGISTRY }}/platform-api-ui:${{ env.TAG }}"

      # â”€â”€ 4. Deploy API (if changed) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Deploy API
        if: fromJSON(steps.changes.outputs.changes).platform-api
        uses: jeff-vincent/kindling/.github/actions/kindling-deploy@main
        with:
          name: "${{ github.actor }}-platform-api"
          image: "${{ env.REGISTRY }}/platform-api:${{ env.TAG }}"
          port: "8080"
          labels: |
            app.kubernetes.io/part-of: platform-api
            app.kubernetes.io/component: api
            apps.example.com/github-username: ${{ github.actor }}
          ingress-host: "${{ github.actor }}-platform-api.localhost"
          dependencies: |
            - type: postgres
              version: "16"
            - type: redis
            - type: elasticsearch
            - type: kafka
            - type: vault

      # â”€â”€ 5. Deploy UI (if changed) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Deploy UI
        if: fromJSON(steps.changes.outputs.changes).platform-api-ui
        uses: jeff-vincent/kindling/.github/actions/kindling-deploy@main
        with:
          name: "${{ github.actor }}-platform-api-ui"
          image: "${{ env.REGISTRY }}/platform-api-ui:${{ env.TAG }}"
          port: "80"
          health-check-path: "/"
          labels: |
            app.kubernetes.io/part-of: platform-api
            app.kubernetes.io/component: ui
            apps.example.com/github-username: ${{ github.actor }}
          env: |
            - name: API_URL
              value: "http://${{ github.actor }}-platform-api:8080"
          ingress-host: "${{ github.actor }}-platform-ui.localhost"

      # â”€â”€ 6. Summary â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Deploy summary
        run: |
          echo ""
          echo "ğŸ‰ Deploy complete!"
          echo "${{ steps.changes.outputs.summary }}"
          echo ""
          echo "ğŸŒ Dashboard: http://${{ github.actor }}-platform-ui.localhost"
          echo "ğŸŒ API:       http://${{ github.actor }}-platform-api.localhost"
